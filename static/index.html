<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-Agent Debate</title>
</head>
<body>
  <h1>Multi-Agent Debate System</h1>

  <textarea id="log" rows="20" cols="80" readonly></textarea><br>
  <input type="text" id="messageInput" placeholder="Enter message" />
  <input type="checkbox" id="spontaneousToggle"> Spontaneous intervention
  <button id="sendButton" onclick="sendMessage()">Send</button>

  <script>
    let ws;
    let isPlaying = false;
    let audioQueue = [];
    let userHasTurn = false;

    function log(message) {
      const logBox = document.getElementById("log");
      logBox.value += message + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    }

    function playNextAudio() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        return;
      }

      const url = audioQueue.shift();
      isPlaying = true;
      log("🔊 Preparing to play: " + url);

      // Short delay before playing to avoid race condition
      setTimeout(() => {
        const audio = new Audio(url);
        log("🔊 Playing audio from: " + url);

        audio.onended = () => {
          isPlaying = false;
          playNextAudio();
        };

        audio.onerror = () => {
          log("❌ Error playing audio.");
          isPlaying = false;
          playNextAudio();
        };

        audio.play().catch(err => {
          log("❌ Play() failed: " + err.message);
          isPlaying = false;
          playNextAudio();
        });
      }, 300);
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      let message = input.value.trim();
      const spontaneous = !userHasTurn && document.getElementById("spontaneousToggle").checked;

      if (!message || ws.readyState !== WebSocket.OPEN) return;

      if (spontaneous) {
        message = `__SPONTANEOUS__${message}`;
        log("⚡ Spontaneous intervention sent.");
      } else {
        log("🧑 You: " + message);
        userHasTurn = false;
        document.getElementById("messageInput").placeholder = "Wait for your turn...";
      }

      ws.send(message);
      input.value = "";
      document.getElementById("sendButton").disabled = true;
    }

    window.onload = () => {
      ws = new WebSocket("wss://doubt-02.onrender.com/ws");

      ws.onopen = () => {
        log("✅ Connected to debate server");
      };

      ws.onmessage = (event) => {
        if (event.data.startsWith("__AUDIO_URL__/")) {
          const audioUrl = "https://doubt-02.onrender.com/" + event.data.replace("__AUDIO_URL__/", "");
          audioQueue.push(audioUrl);
          if (!isPlaying) {
            playNextAudio();
          }
          return;
        }

        if (event.data === "__USER_PROXY_TURN__") {
          userHasTurn = true;
          document.getElementById("messageInput").placeholder = "Your turn. Enter your message...";
          document.getElementById("sendButton").disabled = false;
          log("🎙️ It's your turn to speak.");
          return;
        }

        log(event.data);
      };

      ws.onclose = () => {
        log("❌ Connection closed");
      };
    };

    document.getElementById("messageInput").addEventListener("input", function () {
      const hasText = this.value.trim().length > 0;
      document.getElementById("sendButton").disabled = !hasText;
    });

    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send("__ping__");
      }
    }, 20000);
  </script>
</body>
</html>