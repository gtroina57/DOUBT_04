<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-Agent Debate</title>
</head>
<body>
  <h1>Multi-Agent Debate System</h1>
  <textarea id="log" rows="20" cols="80" readonly></textarea><br>
  <input type="text" id="input" placeholder="Enter message" />
  <button onclick="sendMessage()">Send</button>

  <script>
    let ws;
    let isPlaying = false;
    let audioQueue = [];

    function log(message) {
      const logBox = document.getElementById("log");
      logBox.value += message + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    }

    function sendMessage() {
      const input = document.getElementById("input");
      if (input.value.trim() !== "") {
        ws.send(input.value);
        input.value = "";
      }
    }

    function playNextAudio() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        return;
      }

      const url = audioQueue.shift();
      isPlaying = true;
      log("üîä Preparing to play: " + url);

      // Short delay before playing to avoid race condition
      setTimeout(() => {
        const audio = new Audio(url);
        log("üîä Playing audio from: " + url);

        audio.onended = () => {
          isPlaying = false;
          playNextAudio();
        };

        audio.onerror = () => {
          log("‚ùå Error playing audio.");
          isPlaying = false;
          playNextAudio();
        };

        audio.play().catch(err => {
          log("‚ùå Play() failed: " + err.message);
          isPlaying = false;
          playNextAudio();
        });
      }, 300); // Delay of 300ms
    }

    window.onload = () => {
      ws = new WebSocket("wss://doubt-02.onrender.com/ws");

      ws.onopen = () => {
        log("‚úÖ Connected to debate server");
      };

      ws.onmessage = (event) => {
        if (event.data.startsWith("__AUDIO_URL__/")) {
          const audioUrl = "https://doubt-02.onrender.com/" + event.data.replace("__AUDIO_URL__/, "");
          audioQueue.push(audioUrl);
          if (!isPlaying) {
            playNextAudio();
          }
          return;
        }
        log(event.data);
      };

      ws.onclose = () => {
        log("‚ùå Connection closed");
      };
    };
  </script>
</body>
</html>

  function log(message) {
    const logArea = document.getElementById("log");
    logArea.value += message + "\n";
    logArea.scrollTop = logArea.scrollHeight;
  }

  function setTopic() {
    const topic = document.getElementById("topicInput").value.trim();
    if (topic && ws.readyState === WebSocket.OPEN) {
      ws.send(`__SET_TASK1__:${topic}`);
      log("üìò Topic sent: " + topic);
    }
  }

  function sendMessage() {
    const input = document.getElementById("messageInput");
    let message = input.value.trim();
    const spontaneous = !userHasTurn && document.getElementById("spontaneousToggle").checked;

    if (!message || ws.readyState !== WebSocket.OPEN) return;

    if (spontaneous) {
      message = `__SPONTANEOUS__${message}`;
      log("‚ö° Spontaneous intervention sent.");
    } else {
      log("üßë You: " + message);
      userHasTurn = false;
      document.getElementById("messageInput").placeholder = "Wait for your turn...";
    }

    ws.send(message);
    input.value = "";
    document.getElementById("sendButton").disabled = true;
  }

  // Prevent sending empty messages and enable button when there's content
  document.getElementById("messageInput").addEventListener("input", function () {
    const hasText = this.value.trim().length > 0;
    document.getElementById("sendButton").disabled = !hasText;
  });

  setInterval(() => {
    if (ws.readyState === WebSocket.OPEN) {
      ws.send("__ping__");
    }
  }, 20000);
</script>
</body>
</html>
